{% extends 'dashboard/main.html' %}
{% load static %}

{% block dashboard_content %}

<button type="button"
        class="fab-add-cycle"
        data-bs-toggle="modal"
        data-bs-target="#cycleModal">
  <span class="fab-icon">ï¼‹</span>
  <span class="fab-text">Add Cycle</span>
</button>

<div class="dashboard-layout-wrapper">
  
  <div class="calendar-column">
    <section class="cycle-calendar">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="mb-0">Your Cycle Calendar</h4>
      </div>
      <div id="calendar"></div>
    </section>
  </div>

  <div class="vertical-divider"></div>

  <div class="history-column">
    <h5 class="mb-4">Cycle Logs</h5>
    <div class="history-scroll-container">
      {% for log in logs %}
        <div class="history-item-mini card shadow-sm mb-3" 
             role="button" 
             data-bs-toggle="modal" 
             data-bs-target="#historyModal{{ log.id }}"
             title="Click for full details">
          <div class="card-body p-2">
            <div class="d-flex align-items-center gap-2 mb-1">
              <span class="emoji-indicator">ðŸ©¸</span>
              <small class="fw-bold">{{ log.last_period_start|date:"M d, Y" }}</small>
            </div>
            <div class="prediction-hint">
              <small class="text-muted">Next: {{ log.predicted_next_period|date:"M d" }}</small>
            </div>
          </div>
        </div>

        <div class="modal fade" id="historyModal{{ log.id }}" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Cycle Details</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <h6 class="mb-3">ðŸ§¾ Logged Data</h6>
                <p><strong>Start Date:</strong> {{ log.last_period_start }}</p>
                <p><strong>Cycle Length:</strong> {{ log.length_of_cycle }} days</p>
                <p><strong>Bleeding:</strong> {{ log.get_mean_bleeding_intensity_display }}</p>
                <hr>
                <h6 class="mb-3">ðŸ”® Predictions</h6>
                <p><strong>Predicted Next:</strong> {{ log.predicted_next_period }}</p>
                <p><strong>Ovulation:</strong> {{ log.estimated_ovulation_day }}</p>
                <p><strong>Fertile Window:</strong> {{ log.fertile_window_start }} - {{ log.fertile_window_end }}</p>
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <p class="text-muted small px-2">No history logs found.</p>
      {% endfor %}
    </div>
  </div>
</div>

<div class="modal fade" id="cycleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{% url 'add_cycle_log' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Log New Cycle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="cycle-form">
            {{ form.as_p }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Save Log</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var calendarEl = document.getElementById('calendar');
  var events = [];

  {% for log in logs %}
    {% if log.last_period_start %}
    events.push({
      title: 'ðŸ©¸ Start',
      start: '{{ log.last_period_start|date:"Y-m-d" }}',
      color: '#dc3545'
    });
    {% endif %}

    {% if log.predicted_next_period %}
    events.push({
      title: 'ðŸ”® Predicted',
      start: '{{ log.predicted_next_period|date:"Y-m-d" }}',
      color: '#ff85a2'
    });
    {% endif %}

    {% if log.estimated_ovulation_day %}
    events.push({
      title: 'ðŸŸ£ Ovulation',
      start: '{{ log.estimated_ovulation_day|date:"Y-m-d" }}',
      color: '#6f42c1'
    });
    {% endif %}

    {% if log.fertile_window_start and log.fertile_window_end %}
    events.push({
      title: 'ðŸŒ¿ Fertile',
      start: '{{ log.fertile_window_start|date:"Y-m-d" }}',
      end: '{{ log.fertile_window_end|date:"Y-m-d" }}',
      display: 'background',
      color: '#198754'
    });
    {% endif %}
  {% endfor %}

  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 'auto',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: ''
    },
    events: events
  });

  calendar.render();
});
</script>

{% endblock %}