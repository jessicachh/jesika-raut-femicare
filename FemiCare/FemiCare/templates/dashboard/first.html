{% extends 'dashboard/main.html' %}
{% load static %}

{% block dashboard_content %}

<button type="button"
        class="fab-add-cycle"
        data-bs-toggle="modal"
        data-bs-target="#cycleModal">
  <span class="fab-icon">ï¼‹</span>
  <span class="fab-text">Add Cycle</span>
</button>

<!-- Calendar View -->
<section class="cycle-calendar mb-5">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0">Your Cycle Calendar</h4>
  </div>

  <div id="calendar"></div>
</section>


<!-- Previous Logs -->
<section class="cycle-history">
 <div class="d-flex align-items-center gap-3 mb-3">
  <h4 class="mb-0">Your Cycle Logs</h4>

  <button
    class="btn btn-sm btn-outline-danger"
    id="toggleHistoryBtn"
    type="button"
  >
    View
  </button>
</div>


<div id="cycleHistory" style="display: none;">
  <div class="row">

    {% for log in logs %}
      <div class="col-md-6 col-lg-4 mb-4">

        <!-- CARD -->
        <div
          class="card shadow-sm cycle-card"
          role="button"
          data-bs-toggle="modal"
          data-bs-target="#historyModal{{ log.id }}"
          title="Click to view full details"
        >
          <div class="card-body">
            <h6 class="card-title mb-2">
              ðŸ©¸ Last period
            </h6>

            <p class="mb-1">
              <strong>Started:</strong> {{ log.last_period_start }}
            </p>

            <p class="mb-1">
              <strong>Next:</strong> {{ log.predicted_next_period }}
            </p>

            <p class="text-muted small mt-2">
              Click to view full details â†’
            </p>
          </div>
        </div>

        <!-- MODAL (FULL DETAILS, READ-ONLY) -->
        <div class="modal fade" id="historyModal{{ log.id }}" tabindex="-1">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

              <div class="modal-header">
                <h5 class="modal-title">Cycle Details</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
              </div>

              <div class="modal-body">
                <h6 class="mb-3">ðŸ§¾ What you logged</h6>

                <p><strong>Last period start:</strong> {{ log.last_period_start }}</p>
                <p><strong>Cycle length:</strong> {{ log.length_of_cycle }} days</p>
                <p><strong>Menses length:</strong> {{ log.length_of_menses }} days</p>
                <p><strong>Bleeding intensity:</strong> {{ log.get_mean_bleeding_intensity_display }}</p>
                <p><strong>Unusual bleeding:</strong> {{ log.unusual_bleeding|yesno:"Yes,No" }}</p>

                <hr>

                <h6 class="mb-3">ðŸ”® Predictions</h6>

                <p><strong>Next period:</strong> {{ log.predicted_next_period }}</p>
                <p><strong>Ovulation day:</strong> {{ log.estimated_ovulation_day }}</p>
                <p>
                  <strong>Fertile window:</strong>
                  {{ log.fertile_window_start }} â†’ {{ log.fertile_window_end }}
                </p>
              </div>

              <div class="modal-footer">
                <small class="text-muted me-auto">
                  ðŸ”’ This data is read-only
                </small>
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                  Close
                </button>
              </div>

            </div>
          </div>
        </div>

      </div>
    {% empty %}
      <p class="text-muted">No cycle history yet.</p>
    {% endfor %}

  </div>
</div>


</section>





<script>
document.getElementById("toggleHistoryBtn").addEventListener("click", function () {
  const history = document.getElementById("cycleHistory");

  if (history.style.display === "none") {
    history.style.display = "block";
    this.innerText = "Hide";
  } else {
    history.style.display = "none";
    this.innerText = "View";
  }
});

document.addEventListener('DOMContentLoaded', function () {

  var calendarEl = document.getElementById('calendar');

  var events = [];

  {% for log in logs %}

    {% if log.last_period_start %}
    events.push({
      title: 'ðŸ©¸ Period Start',
      start: '{{ log.last_period_start|date:"Y-m-d" }}',
      color: '#dc3545'
    });
    {% endif %}

    {% if log.predicted_next_period %}
    events.push({
      title: 'ðŸ”® Predicted Period',
      start: '{{ log.predicted_next_period|date:"Y-m-d" }}',
      color: '#ff85a2'
    });
    {% endif %}

    {% if log.estimated_ovulation_day %}
    events.push({
      title: 'ðŸŸ£ Ovulation',
      start: '{{ log.estimated_ovulation_day|date:"Y-m-d" }}',
      color: '#6f42c1'
    });
    {% endif %}

    {% if log.fertile_window_start and log.fertile_window_end %}
    events.push({
      title: 'ðŸŒ¿ Fertile Window',
      start: '{{ log.fertile_window_start|date:"Y-m-d" }}',
      end: '{{ log.fertile_window_end|date:"Y-m-d" }}',
      display: 'background',
      color: '#198754'
    });
    {% endif %}

  {% endfor %}

  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 650,
    headerToolbar: {
      left: 'prev,next',
      center: 'title',
      right: 'today'
    },
    events: events
  });

  calendar.render();
});


</script>



{% endblock %}