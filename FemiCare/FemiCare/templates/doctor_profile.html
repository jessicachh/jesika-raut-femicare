{% load static %}
{% include 'components/navbar.html' %}
<head>
<!-- Gogogle Font -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap"
  rel="stylesheet"
/>
<!-- Phosphor Icons -->
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/regular/style.css"
/>
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/fill/style.css"
/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- CSS -->
<link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body>
    
<section class="doctors-section">
<div class="public-doctor-container">

  <!-- PROFILE HEADER -->
  <div class="doctor-header">
    <img
      src="{{ doctor.photo.url }}"
      class="doctor-avatar"
      alt="Doctor photo"
    />

    <div class="doctor-header-info">
      <h2>Dr. {{ doctor.full_name }}</h2>

      <p class="doctor-specialization">
        {{ doctor.specialization }}
      </p>

      
  <div class="doctor-rating">
  <strong>Rating:</strong>
  {{ doctor.average_rating|floatformat:1 }} ⭐
  <span class="text-muted">
    ({{ doctor.reviews.count }} reviews)
  </span>
</div>

      <span class="verified-pill">
        ✔ Verified Doctor
      </span>
      
    </div>
  </div>
  <!-- DETAILS -->
<div class="doctor-card doctor-details-card">
  <div class="doctor-detail-item">
    <strong>License No:</strong>
    <span>{{ doctor.license_number }}</span>
  </div>

  <div class="doctor-detail-item">
    <strong>Hospital:</strong>
    <span>{{ doctor.hospital_name }}</span>
  </div>

  <div class="doctor-detail-item">
    <strong>Experience:</strong>
    <span>{{ doctor.experience_years }} years</span>
  </div>
  <div class="doctor-detail-item">
    <strong>Qualifications:</strong>
    <span>{{ doctor.qualifications }}</span>
  </div>
  <div class="doctor-detail-item">
  <strong>Clinic Address:</strong>
  <span>{{ doctor.clinic_address }}</span>
</div>
<div class="doctor-detail-item">
  <strong>Languages:</strong>
  <span>{{ doctor.languages_spoken }}</span>
</div>
<div class="doctor-detail-item">
  <strong>Working Hours:</strong>
  <span>{{ doctor.working_hours }}</span>
</div>

<div class="doctor-detail-item">
  <strong>Consultation Fee:</strong>
  <span>Rs. {{ doctor.consultation_fee }}</span>
</div>
</div>

  <!-- BIO -->
  <div class="doctor-card">
    <h4>About Doctor</h4>
    <p>{{ doctor.bio }}</p>
  </div>

<!-- AVAILABILITY -->
<div class="doctor-card mt-4">
  <h4 class="mb-4"><i class="ph ph-calendar-check"></i> Book an Appointment</h4>

  {% regroup availabilities by date as date_list %}

  {% if date_list %}

  <!-- DATE RIBBON -->
  <div class="date-ribbon">
    {% for day in date_list %}
    <button type="button"
      class="date-tab-btn {% if forloop.first %}active{% endif %}"
      onclick="switchBookingDay('day-{{ forloop.counter }}', this)">
      <span class="day-name">{{ day.grouper|date:"D" }}</span>
      <span class="day-date">{{ day.grouper|date:"d M" }}</span>
    </button>
    {% endfor %}
  </div>

  <!-- DAY PANES -->
  {% for day in date_list %}
  <div id="day-{{ forloop.counter }}"
       class="booking-day-pane"
       {% if not forloop.first %}style="display:none"{% endif %}>

    <p class="slot-heading">
      Available times for <strong>{{ day.grouper|date:"l, F j" }}</strong>
    </p>

    <div class="time-slot-grid">
      {% for slot in day.list %}
<button type="button" class="slot-btn"
        onclick="openBookingModal(
            '{{ slot.id }}',
            '{{ doctor.user.get_full_name }}',
            '{{ slot.date }}',
            '{{ slot.start_time }}'
        )">
    {{ slot.start_time }}
</button>
      {% endfor %}
    </div>

  </div>
  {% endfor %}


  {% else %}
  <div class="empty-slots-state">
    <i class="ph ph-calendar-x"></i>
    <p>No available slots.</p>
  </div>
  {% endif %}
</div>

<div class="doctor-card">
  <h4>Patient Reviews</h4>

  {% if reviews %}
    {% for review in reviews %}
      <div class="review-box">
        <strong>{{ review.patient.username }}</strong>
        <span>{{ review.rating }} ⭐</span>

        {% if review.comment %}
          <p>{{ review.comment }}</p>
        {% endif %}

        <small class="text-muted">
          {{ review.created_at|date:"M d, Y" }}
        </small>
      </div>
      <hr>
    {% endfor %}
  {% else %}
    <p class="text-muted">No reviews yet.</p>
  {% endif %}
</div>


{% if user.is_authenticated and user.role == "user" %}
<div class="doctor-card">
  <h4>Leave a Review</h4>

  <form method="POST" action="{% url 'submit_doctor_review' doctor.pk %}">
    {% csrf_token %}

    <label>Rating</label>
    <select name="rating" class="form-control mb-2" required>
      <option value="">Select</option>
      {% for i in "12345" %}
        <option value="{{ i }}">{{ i }} ⭐</option>
      {% endfor %}
    </select>

    <textarea
      name="comment"
      class="form-control mb-2"
      placeholder="Write your experience..."
    ></textarea>

    <button class="btn" style="background-color: #b92222; color:white;">Submit Review</button>
  </form>
</div>
{% endif %}

</div>





<!-- Dynamic Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content booking-modal">

            <div class="modal-header">
                <h5 class="modal-title">Confirm Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form method="POST" id="bookingForm">
                {% csrf_token %}

<div class="modal-body">

    <p><strong>Doctor:</strong> <span id="modalDoctor"></span></p>
    <p><strong>Date:</strong> <span id="modalDate"></span></p>
    <p><strong>Time:</strong> <span id="modalTime"></span></p>

    <input type="hidden" name="doctor" id="doctorInput">
    <input type="hidden" name="date" id="dateInput">
    <input type="hidden" name="time" id="timeInput">

    <!-- ⭐ REASON FIELD -->
    <label class="form-label mt-3">Reason for appointment</label>
    <textarea name="reason"
        class="form-control"
        placeholder="Describe your concern..."
        required></textarea>

</div>

                <div class="modal-footer">
                    <button type="submit" class="btn" style="background-color: #b92222; color:white;">Confirm Booking</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>

            </form>

        </div>
    </div>
</div>





</section>
{% include 'components/footer.html' %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function switchBookingDay(dayId, btn){

    // hide all panes
    document.querySelectorAll('.booking-day-pane').forEach(p => {
        p.style.display = 'none';
    });

    // remove active state
    document.querySelectorAll('.date-tab-btn').forEach(b => {
        b.classList.remove('active');
    });

    // show selected
    document.getElementById(dayId).style.display = 'block';

    // activate button
    btn.classList.add('active');
}
</script>
<script>
const bookingModalEl = document.getElementById('bookingModal');
const bookingModal = new bootstrap.Modal(bookingModalEl);

function openBookingModal(slotId, doctorName, date, time){

    // display
    document.getElementById('modalDoctor').innerText = doctorName;
    document.getElementById('modalDate').innerText = date;
    document.getElementById('modalTime').innerText = time;

    // ⭐ dynamically set form action
    document.getElementById('bookingForm').action = "/book/" + slotId + "/";

    bookingModal.show();
}

// reset
bookingModalEl.addEventListener('hidden.bs.modal', function () {
    document.getElementById('bookingForm').reset();
});
</script>

<script>
bookingModalEl.addEventListener('hidden.bs.modal', function () {
    document.getElementById('bookingForm').reset();
});
</script>
</body>